<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ejercicio</title>
    <style>
      :root {
        --bg: #f5f5f5;
        --white: #ffffff;
        --black: #1f1f1f;
        --accent: #4aa3ff;
        --shadow: 0 8px 20px rgba(0, 0, 0, 0.08);

        --sel: #facc15; /* amarillo */
        --ok: #22c55e;  /* verde */
        --bad: #ef4444; /* rojo */
        --muted: #6b7280;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 22px 16px;
        background: var(--bg);
        font-family: Arial, sans-serif;
      }

      .card {
        width: min(920px, 100%);
        background: rgba(255, 255, 255, 0.72);
        border-radius: 22px;
        padding: 16px 18px 18px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(6px);
        position: relative;
        overflow: hidden;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
      }

      .title {
        font-size: 20px;
        font-weight: 900;
        margin: 0;
        color: #111827;
        user-select: none;
      }

      .score {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        border-radius: 16px;
        background: #ffffff;
        box-shadow: var(--shadow);
        font-weight: 900;
        color: #111827;
        user-select: none;
      }

      .score small {
        color: var(--muted);
        font-weight: 900;
      }

      .choices {
        display: grid;
        grid-template-columns: repeat(4, minmax(70px, 90px));
        gap: 16px 20px;
        justify-content: center;
        margin-top: 10px;
      }

      .note-group {
        display: grid;
        gap: 10px;
        align-items: center;
        justify-items: center;
        padding: 8px 6px;
        border-radius: 16px;
      }

      button.note {
        border: none;
        cursor: pointer;
        width: 82px;
        height: 62px;
        border-radius: 18px;
        box-shadow: var(--shadow);
        transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease,
          opacity 0.12s ease;
        position: relative;
      }

      button.note:focus-visible {
        outline: 3px solid var(--accent);
        outline-offset: 4px;
      }

      .white { background: var(--white); }
      .black { background: var(--black); }

      .selected {
        outline: 7px solid var(--sel);
        outline-offset: 4px;
        box-shadow:
          0 12px 26px rgba(0,0,0,.14),
          0 0 0 10px rgba(250,204,21,.22);
        transform: translateY(-2px) scale(1.02);
      }
      .selected::after{
        content:"";
        position:absolute;
        width:14px; height:14px;
        border-radius:999px;
        background: var(--sel);
        top: 8px; right: 8px;
        box-shadow: 0 6px 14px rgba(0,0,0,.18);
      }

      .result-ok {
        outline: 7px solid var(--ok) !important;
        outline-offset: 4px !important;
        box-shadow:
          0 12px 26px rgba(0,0,0,.14),
          0 0 0 10px rgba(34,197,94,.20) !important;
        transform: translateY(-2px) scale(1.02);
      }
      .result-ok::after{
        content:"";
        position:absolute;
        width:14px; height:14px;
        border-radius:999px;
        background: var(--ok);
        top: 8px; right: 8px;
        box-shadow: 0 6px 14px rgba(0,0,0,.18);
      }

      .result-bad {
        outline: 7px solid var(--bad) !important;
        outline-offset: 4px !important;
        box-shadow:
          0 12px 26px rgba(0,0,0,.14),
          0 0 0 10px rgba(239,68,68,.20) !important;
        transform: translateY(-2px) scale(1.02);
      }
      .result-bad::after{
        content:"";
        position:absolute;
        width:14px; height:14px;
        border-radius:999px;
        background: var(--bad);
        top: 8px; right: 8px;
        box-shadow: 0 6px 14px rgba(0,0,0,.18);
      }

      .controls {
        display: flex;
        gap: 12px;
        justify-content: center;
        align-items: center;
        margin-top: 16px;
      }

      .btn {
        border: none;
        cursor: pointer;
        width: 90px;
        height: 70px;
        border-radius: 22px;
        box-shadow: var(--shadow);
        font-size: 30px;
        font-weight: 900;
        transition: transform 0.1s ease, opacity 0.15s ease, filter 0.15s ease;
        display: grid;
        place-items: center;
        user-select: none;
      }

      .btn:active { transform: scale(0.98); }
      .btn-primary { background: var(--accent); color: #fff; }
      .btn-check { background: #111827; color: #fff; }
      .btn-ghost { background: #fff; color: #111827; }

      .btn[disabled] {
        opacity: 0.28;
        cursor: not-allowed;
        filter: grayscale(0.2);
      }

      .speaker {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.15s ease;
      }
      .speaker.show { opacity: 1; }
      .speaker .bubble {
        width: 120px;
        height: 120px;
        border-radius: 32px;
        background: rgba(255, 255, 255, 0.88);
        box-shadow: var(--shadow);
        display: grid;
        place-items: center;
        backdrop-filter: blur(6px);
      }
      .speaker svg { width: 66px; height: 66px; }
    </style>
  </head>

  <body>
    <div class="card" aria-label="Ejercicio">
      <div class="topbar">
        <h1 class="title" id="title">MelodÃ­a 1</h1>
        <div class="score" aria-label="Marcador">
          <small>âœ“</small>
          <span id="scoreText">0/0</span>
        </div>
      </div>

      <div class="choices" aria-label="Elegir blanco o negro">
        <div class="note-group" data-index="0">
          <button class="note white" aria-label="1 blanco"></button>
          <button class="note black" aria-label="1 negro"></button>
        </div>
        <div class="note-group" data-index="1">
          <button class="note white" aria-label="2 blanco"></button>
          <button class="note black" aria-label="2 negro"></button>
        </div>
        <div class="note-group" data-index="2">
          <button class="note white" aria-label="3 blanco"></button>
          <button class="note black" aria-label="3 negro"></button>
        </div>
        <div class="note-group" data-index="3">
          <button class="note white" aria-label="4 blanco"></button>
          <button class="note black" aria-label="4 negro"></button>
        </div>
      </div>

      <div class="controls" aria-label="Controles">
        <button class="btn btn-primary" id="listen" aria-label="Escuchar">â–¶</button>
        <button class="btn btn-check" id="check" aria-label="Comprobar">âœ“</button>
        <button class="btn btn-ghost" id="new" aria-label="Nuevo" disabled>â†»</button>
      </div>

      <div class="speaker" id="speaker" aria-hidden="true">
        <div class="bubble">
          <svg viewBox="0 0 64 64" fill="none">
            <path d="M28 22L18 30H10v4h8l10 8V22z" fill="#111827" />
            <path d="M40 24c3 3 3 13 0 16" stroke="#4aa3ff" stroke-width="4" stroke-linecap="round" />
            <path d="M48 18c6 6 6 22 0 28" stroke="#4aa3ff" stroke-width="4" stroke-linecap="round" opacity=".75" />
          </svg>
        </div>
      </div>
    </div>

    <script>
      const NOTE_COUNT = 4;
      const GAP = 0.08;

      // ==========================
      // âœ… MP3 en la misma carpeta (AUDIO_FOLDER vacÃ­o)
      // ==========================
      const AUDIO_FOLDER = ""; // <-- dÃ©jalo asÃ­ si estÃ¡n junto al HTML

      // ðŸ”§ CAMBIA AQUÃ si algÃºn nombre no coincide EXACTO
      const SAMPLES = {
        do:  { white: AUDIO_FOLDER + "do_blanca.mp3",  black: AUDIO_FOLDER + "do_negra.mp3"  },
        re:  { white: AUDIO_FOLDER + "re_blanca.mp3",  black: AUDIO_FOLDER + "re_negra.mp3"  },
        mi:  { white: AUDIO_FOLDER + "mi_blanca.mp3",  black: AUDIO_FOLDER + "mi_negra.mp3"  },
        fa:  { white: AUDIO_FOLDER + "fa_blanca.mp3",  black: AUDIO_FOLDER + "fa_negra.mp3"  },
        sol: { white: AUDIO_FOLDER + "sol_blanca.mp3", black: AUDIO_FOLDER + "sol_negra.mp3" },
        la:  { white: AUDIO_FOLDER + "la_blanca.mp3",  black: AUDIO_FOLDER + "la_negra.mp3"  },
        si:  { white: AUDIO_FOLDER + "si_blanca.mp3",  black: AUDIO_FOLDER + "si_negra.mp3"  },
      };

      function pickPrettyMelodyNames() {
        const presets = [
          // Tus 5 (mantengo)
          ["do", "re", "mi", "sol"],
          ["do", "mi", "sol", "fa"],
          ["re", "mi", "fa", "sol"],
          ["mi", "re", "do", "sol"],
          ["sol", "fa", "mi", "re"],

          // +25 nuevas (usando do re mi fa sol la si)
          ["do", "re", "fa", "sol"],
          ["do", "mi", "fa", "sol"],
          ["do", "fa", "mi", "re"],
          ["do", "sol", "fa", "mi"],
          ["do", "mi", "re", "do"],

          ["re", "fa", "sol", "la"],
          ["re", "sol", "la", "si"],
          ["re", "mi", "sol", "si"],
          ["re", "do", "mi", "fa"],
          ["re", "la", "sol", "fa"],

          ["mi", "fa", "sol", "la"],
          ["mi", "sol", "la", "si"],
          ["mi", "la", "sol", "mi"],
          ["mi", "re", "fa", "la"],
          ["mi", "si", "la", "sol"],

          ["fa", "sol", "la", "sol"],
          ["fa", "mi", "re", "do"],
          ["fa", "la", "sol", "mi"],
          ["fa", "re", "mi", "sol"],
          ["fa", "sol", "si", "la"],

          ["sol", "la", "si", "do"],
          ["sol", "fa", "mi", "re"],
          ["sol", "mi", "re", "do"],
          ["sol", "si", "la", "sol"],
          ["sol", "do", "mi", "la"],

          ["la", "si", "do", "re"],
          ["la", "sol", "fa", "mi"],
          ["la", "mi", "fa", "sol"],
          ["si", "la", "sol", "fa"],
          ["si", "sol", "la", "do"],
        ];
        return presets[Math.floor(Math.random() * presets.length)];
      }

      // Marcador / reglas
      let totalCorrect = 0;
      let totalAttempts = 0;
      let scoredThisMelody = false;
      let unlocked = false;

      let melodyIndex = 1;
      let currentMelody = pickPrettyMelodyNames();
      let answer = generateAnswer();
      const selections = Array(NOTE_COUNT).fill(null);

      const groups = document.querySelectorAll(".note-group");
      const listenBtn = document.getElementById("listen");
      const checkBtn = document.getElementById("check");
      const newBtn = document.getElementById("new");
      const titleEl = document.getElementById("title");
      const scoreText = document.getElementById("scoreText");
      const speakerEl = document.getElementById("speaker");

      function updateScore() {
        scoreText.textContent = `${totalCorrect}/${totalAttempts}`;
      }
      updateScore();

      // ==========================
      // âœ… Evitar solapes: una reproducciÃ³n por click
      // ==========================
      let isPlaying = false;
      let activeSources = [];

      function showSpeaker() { speakerEl.classList.add("show"); }
      function hideSpeaker() { speakerEl.classList.remove("show"); }

      function stopPlayback() {
        try { hideSpeaker(); } catch(e) {}
        activeSources.forEach(src => { try { src.stop(0); } catch(e) {} });
        activeSources = [];
        isPlaying = false;
        if (!unlocked) listenBtn.disabled = false;
      }

      // AudioContext + cache
      let ctx = null;
      const bufferCache = new Map();

      function getAudioContext() {
        if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
        if (ctx.state === "suspended") ctx.resume();
        return ctx;
      }

      async function loadBuffer(url) {
        if (bufferCache.has(url)) return bufferCache.get(url);
        const res = await fetch(url);
        if (!res.ok) throw new Error("No se pudo cargar: " + url);
        const arr = await res.arrayBuffer();
        const ac = getAudioContext();
        const buf = await ac.decodeAudioData(arr);
        bufferCache.set(url, buf);
        return buf;
      }

      function playBufferAt(buffer, startTime) {
        const ac = getAudioContext();
        const src = ac.createBufferSource();
        src.buffer = buffer;

        // ðŸ”§ Volumen global (sube a 1.2 si tu mp3 va flojo, o baja a 0.8)
        const gain = ac.createGain();
        gain.gain.setValueAtTime(1.0, startTime);

        src.connect(gain).connect(ac.destination);

        activeSources.push(src);
        src.onended = () => {
          activeSources = activeSources.filter(s => s !== src);
        };

        src.start(startTime);
        return buffer.duration;
      }

      // UI selection
      groups.forEach((group) => {
        const index = Number(group.dataset.index);
        const buttons = group.querySelectorAll("button.note");

        buttons.forEach((button) => {
          button.addEventListener("click", () => {
            if (unlocked) return;

            buttons.forEach((btn) => btn.classList.remove("selected", "result-ok", "result-bad"));
            button.classList.add("selected");
            selections[index] = button.classList.contains("white") ? "white" : "black";
            newBtn.disabled = true;
          });
        });
      });

      function generateAnswer() {
        let arr;
        do {
          arr = Array.from({ length: NOTE_COUNT }, () => (Math.random() < 0.5 ? "white" : "black"));
        } while (arr.every((x) => x === "white") || arr.every((x) => x === "black"));
        return arr;
      }

      function clearAllResultBorders() {
        groups.forEach((group) => {
          const buttons = group.querySelectorAll("button.note");
          buttons.forEach((btn) => btn.classList.remove("result-ok", "result-bad"));
        });
      }

      async function playAnswerMelody() {
        if (unlocked) return;
        if (isPlaying) return;

        stopPlayback();
        isPlaying = true;
        listenBtn.disabled = true;

        clearAllResultBorders();

        const ac = getAudioContext();
        const start = ac.currentTime + 0.05;
        showSpeaker();

        // Precarga
        const urls = [];
        for (let i = 0; i < NOTE_COUNT; i++) {
          const noteName = currentMelody[i];
          const kind = answer[i];
          const url = SAMPLES[noteName]?.[kind];
          if (!url) throw new Error(`Falta sample para ${noteName} (${kind}). Revisa SAMPLES.`);
          urls.push(url);
        }

        const buffers = [];
        for (const url of urls) buffers.push(await loadBuffer(url));

        // ProgramaciÃ³n exacta
        let t = start;
        for (let i = 0; i < NOTE_COUNT; i++) {
          const dur = playBufferAt(buffers[i], t);
          t += dur + GAP;
        }

        const totalMs = (t - start) * 1000 + 80;
        setTimeout(() => {
          hideSpeaker();
          isPlaying = false;
          if (!unlocked) listenBtn.disabled = false;
        }, totalMs);
      }

      function checkAnswers() {
        if (unlocked) return;
        clearAllResultBorders();

        for (let i = 0; i < NOTE_COUNT; i++) {
          if (selections[i] === null) return;
        }

        let correctNow = 0;

        groups.forEach((group, i) => {
          const chosen = selections[i];
          const ok = chosen === answer[i];
          if (ok) correctNow++;

          const chosenBtn = group.querySelector(chosen === "white" ? ".note.white" : ".note.black");
          chosenBtn.classList.remove("selected");
          chosenBtn.classList.add(ok ? "result-ok" : "result-bad");
        });

        if (!scoredThisMelody) {
          totalCorrect += correctNow;
          totalAttempts += NOTE_COUNT;
          scoredThisMelody = true;
          updateScore();
        }

        if (correctNow === NOTE_COUNT) {
          unlocked = true;

          // âœ… congelar play/check y cortar audio si estuviera sonando
          stopPlayback();
          listenBtn.disabled = true;
          checkBtn.disabled = true;

          newBtn.disabled = false;
        } else {
          newBtn.disabled = true;
        }
      }

      function newMelody() {
        if (newBtn.disabled) return;

        stopPlayback();

        melodyIndex++;
        titleEl.textContent = `MelodÃ­a ${melodyIndex}`;

        currentMelody = pickPrettyMelodyNames();
        answer = generateAnswer();
        scoredThisMelody = false;
        unlocked = false;

        listenBtn.disabled = false;
        checkBtn.disabled = false;

        for (let i = 0; i < NOTE_COUNT; i++) selections[i] = null;

        groups.forEach((group) => {
          const buttons = group.querySelectorAll("button.note");
          buttons.forEach((btn) => btn.classList.remove("result-ok", "result-bad", "selected"));
        });

        newBtn.disabled = true;
      }

      listenBtn.addEventListener("click", () => {
        playAnswerMelody().catch(err => {
          console.error(err);
          // Si falla, mira F12 -> Console para ver quÃ© mp3 no encuentra
        });
      });
      checkBtn.addEventListener("click", checkAnswers);
      newBtn.addEventListener("click", newMelody);
    </script>
  </body>
</html>
