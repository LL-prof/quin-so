<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ejercicio</title>
    <style>
      :root {
        --bg: #f5f5f5;
        --white: #ffffff;
        --black: #1f1f1f;
        --accent: #4aa3ff;
        --shadow: 0 8px 20px rgba(0, 0, 0, 0.08);

        --sel: #facc15; /* amarillo */
        --ok: #22c55e;  /* verde */
        --bad: #ef4444; /* rojo */
        --muted: #6b7280;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 22px 16px;
        background: var(--bg);
        font-family: Arial, sans-serif;
      }

      .card {
        width: min(920px, 100%);
        background: rgba(255, 255, 255, 0.72);
        border-radius: 22px;
        padding: 16px 18px 18px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(6px);
        position: relative;
        overflow: hidden;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
      }

      .title {
        font-size: 20px;
        font-weight: 900;
        margin: 0;
        color: #111827;
        user-select: none;
      }

      .score {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        border-radius: 16px;
        background: #ffffff;
        box-shadow: var(--shadow);
        font-weight: 900;
        color: #111827;
        user-select: none;
      }

      .score small {
        color: var(--muted);
        font-weight: 900;
      }

      .choices {
        display: grid;
        grid-template-columns: repeat(4, minmax(70px, 90px));
        gap: 16px 20px;
        justify-content: center;
        margin-top: 10px;
      }

      .note-group {
        display: grid;
        gap: 10px;
        align-items: center;
        justify-items: center;
        padding: 8px 6px;
        border-radius: 16px;
      }

      /* Botones */
      button.note {
        border: none;
        cursor: pointer;
        width: 82px;
        height: 62px;
        border-radius: 18px;
        box-shadow: var(--shadow);
        transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease, opacity 0.12s ease;
        position: relative;
      }

      button.note:focus-visible {
        outline: 3px solid var(--accent);
        outline-offset: 4px;
      }

      .white { background: var(--white); }
      .black { background: var(--black); }

      /* Selección MUY visible */
      .selected {
        outline: 7px solid var(--sel);
        outline-offset: 4px;
        box-shadow:
          0 12px 26px rgba(0,0,0,.14),
          0 0 0 10px rgba(250,204,21,.22);
        transform: translateY(-2px) scale(1.02);
      }
      .selected::after{
        content:"";
        position:absolute;
        width:14px; height:14px;
        border-radius:999px;
        background: var(--sel);
        top: 8px; right: 8px;
        box-shadow: 0 6px 14px rgba(0,0,0,.18);
      }

      /* Resultado tras CHECK */
      .result-ok {
        outline: 7px solid var(--ok) !important;
        outline-offset: 4px !important;
        box-shadow:
          0 12px 26px rgba(0,0,0,.14),
          0 0 0 10px rgba(34,197,94,.20) !important;
        transform: translateY(-2px) scale(1.02);
      }
      .result-ok::after{
        content:"";
        position:absolute;
        width:14px; height:14px;
        border-radius:999px;
        background: var(--ok);
        top: 8px; right: 8px;
        box-shadow: 0 6px 14px rgba(0,0,0,.18);
      }

      .result-bad {
        outline: 7px solid var(--bad) !important;
        outline-offset: 4px !important;
        box-shadow:
          0 12px 26px rgba(0,0,0,.14),
          0 0 0 10px rgba(239,68,68,.20) !important;
        transform: translateY(-2px) scale(1.02);
      }
      .result-bad::after{
        content:"";
        position:absolute;
        width:14px; height:14px;
        border-radius:999px;
        background: var(--bad);
        top: 8px; right: 8px;
        box-shadow: 0 6px 14px rgba(0,0,0,.18);
      }

      .controls {
        display: flex;
        gap: 12px;
        justify-content: center;
        align-items: center;
        margin-top: 16px;
      }

      .btn {
        border: none;
        cursor: pointer;
        width: 90px;
        height: 70px;
        border-radius: 22px;
        box-shadow: var(--shadow);
        font-size: 30px;
        font-weight: 900;
        transition: transform 0.1s ease, opacity 0.15s ease, filter 0.15s ease;
        display: grid;
        place-items: center;
        user-select: none;
      }

      .btn:active { transform: scale(0.98); }
      .btn-primary { background: var(--accent); color: #fff; }
      .btn-check { background: #111827; color: #fff; }
      .btn-ghost { background: #fff; color: #111827; }

      .btn[disabled] {
        opacity: 0.28;
        cursor: not-allowed;
        filter: grayscale(0.2);
      }

      /* Altavoz */
      .speaker {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.15s ease;
      }
      .speaker.show { opacity: 1; }
      .speaker .bubble {
        width: 120px;
        height: 120px;
        border-radius: 32px;
        background: rgba(255, 255, 255, 0.88);
        box-shadow: var(--shadow);
        display: grid;
        place-items: center;
        backdrop-filter: blur(6px);
      }
      .speaker svg { width: 66px; height: 66px; }
    </style>
  </head>

  <body>
    <div class="card" aria-label="Ejercicio">
      <div class="topbar">
        <h1 class="title" id="title">Melodía 1</h1>
        <div class="score" aria-label="Marcador">
          <small>✓</small>
          <span id="scoreText">0/0</span>
        </div>
      </div>

      <div class="choices" aria-label="Elegir blanco o negro">
        <div class="note-group" data-index="0">
          <button class="note white" aria-label="1 blanco"></button>
          <button class="note black" aria-label="1 negro"></button>
        </div>
        <div class="note-group" data-index="1">
          <button class="note white" aria-label="2 blanco"></button>
          <button class="note black" aria-label="2 negro"></button>
        </div>
        <div class="note-group" data-index="2">
          <button class="note white" aria-label="3 blanco"></button>
          <button class="note black" aria-label="3 negro"></button>
        </div>
        <div class="note-group" data-index="3">
          <button class="note white" aria-label="4 blanco"></button>
          <button class="note black" aria-label="4 negro"></button>
        </div>
      </div>

      <div class="controls" aria-label="Controles">
        <button class="btn btn-primary" id="listen" aria-label="Escuchar">▶</button>
        <button class="btn btn-check" id="check" aria-label="Comprobar">✓</button>
        <button class="btn btn-ghost" id="new" aria-label="Nuevo" disabled>↻</button>
      </div>

      <div class="speaker" id="speaker" aria-hidden="true">
        <div class="bubble">
          <svg viewBox="0 0 64 64" fill="none">
            <path d="M28 22L18 30H10v4h8l10 8V22z" fill="#111827"/>
            <path d="M40 24c3 3 3 13 0 16" stroke="#4aa3ff" stroke-width="4" stroke-linecap="round"/>
            <path d="M48 18c6 6 6 22 0 28" stroke="#4aa3ff" stroke-width="4" stroke-linecap="round" opacity=".75"/>
          </svg>
        </div>
      </div>
    </div>

    <script>
      const NOTE_COUNT = 4;

      // Duraciones
      const DUR_BLACK = 0.42;
      const DUR_WHITE = 0.86;
      const GAP = 0.08;

      // Volumen general
      const MASTER_PEAK = 0.42;

      // Marcador
      let totalCorrect = 0;
      let totalAttempts = 0;

      // Modelo C: solo puntúa el primer CHECK de cada melodía
      let scoredThisMelody = false;

      // Congelación por éxito
      let unlocked = false;

      // Melodía actual
      let melodyIndex = 1;
      let currentFreqs = pickPrettyMelody();
      let answer = generateAnswer();

      // Selecciones del alumno: null hasta que elija por primera vez
      const selections = Array(NOTE_COUNT).fill(null);

      const groups = document.querySelectorAll(".note-group");
      const listenBtn = document.getElementById("listen");
      const checkBtn = document.getElementById("check");
      const newBtn = document.getElementById("new");
      const titleEl = document.getElementById("title");
      const scoreText = document.getElementById("scoreText");
      const speakerEl = document.getElementById("speaker");

      function updateScore() {
        scoreText.textContent = `${totalCorrect}/${totalAttempts}`;
      }
      updateScore();

      // UI selection
      groups.forEach((group) => {
        const index = Number(group.dataset.index);
        const buttons = group.querySelectorAll("button.note");

        buttons.forEach((button) => {
          button.addEventListener("click", () => {
            if (unlocked) return; // si ya está 4/4, no se toca nada

            // limpiar estados del grupo
            buttons.forEach((btn) => btn.classList.remove("selected", "result-ok", "result-bad"));

            // marcar selección amarilla
            button.classList.add("selected");
            selections[index] = button.classList.contains("white") ? "white" : "black";

            // al tocar, nunca puedes pasar hasta 4/4
            newBtn.disabled = true;
          });
        });
      });

      // Audio
      let ctx = null;
      function getAudioContext() {
        if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
        if (ctx.state === "suspended") ctx.resume();
        return ctx;
      }

      function playTone(freq, startTime, duration) {
        const context = getAudioContext();
        const osc = context.createOscillator();
        const gain = context.createGain();

        osc.type = "sine";
        osc.frequency.setValueAtTime(freq, startTime);

        const attack = 0.02;
        const release = 0.06;

        gain.gain.setValueAtTime(0.001, startTime);
        gain.gain.exponentialRampToValueAtTime(MASTER_PEAK, startTime + attack);
        gain.gain.exponentialRampToValueAtTime(
          0.001,
          startTime + Math.max(attack + 0.02, duration - release)
        );

        osc.connect(gain).connect(context.destination);
        osc.start(startTime);
        osc.stop(startTime + duration);
      }

      function showSpeaker() { speakerEl.classList.add("show"); }
      function hideSpeaker() { speakerEl.classList.remove("show"); }

      function generateAnswer() {
        let arr;
        do {
          arr = Array.from({ length: NOTE_COUNT }, () => (Math.random() < 0.5 ? "white" : "black"));
        } while (arr.every((x) => x === "white") || arr.every((x) => x === "black"));
        return arr;
      }

      function pickPrettyMelody() {
        const presets = [
          [261.63, 329.63, 392.00, 440.00],
          [261.63, 293.66, 392.00, 440.00],
          [293.66, 329.63, 392.00, 493.88],
          [261.63, 392.00, 440.00, 523.25],
          [220.00, 261.63, 329.63, 392.00],
          [392.00, 440.00, 493.88, 523.25],
          [261.63, 392.00, 329.63, 440.00],
        ];
        return presets[Math.floor(Math.random() * presets.length)];
      }

      function clearAllResultBorders() {
        groups.forEach((group) => {
          const buttons = group.querySelectorAll("button.note");
          buttons.forEach((btn) => btn.classList.remove("result-ok", "result-bad"));
        });
      }

      function playAnswerMelody() {
        if (unlocked) return;
        clearAllResultBorders();

        const context = getAudioContext();
        const start = context.currentTime + 0.03;

        showSpeaker();

        let t = start;
        for (let i = 0; i < NOTE_COUNT; i++) {
          const kind = answer[i];
          const dur = kind === "white" ? DUR_WHITE : DUR_BLACK;
          const freq = currentFreqs[i];
          playTone(freq, t, dur);
          t += dur + GAP;
        }

        setTimeout(hideSpeaker, (t - start) * 1000 + 60);
      }

      function checkAnswers() {
        if (unlocked) return;
        clearAllResultBorders();

        // Si hay columnas sin seleccionar, no hacemos nada
        for (let i = 0; i < NOTE_COUNT; i++) {
          if (selections[i] === null) return;
        }

        let correctNow = 0;

        groups.forEach((group, i) => {
          const chosen = selections[i];
          const ok = chosen === answer[i];
          if (ok) correctNow++;

          const chosenBtn = group.querySelector(chosen === "white" ? ".note.white" : ".note.black");
          chosenBtn.classList.remove("selected");
          chosenBtn.classList.add(ok ? "result-ok" : "result-bad");
        });

        // Solo puntúa el primer CHECK de esta melodía
        if (!scoredThisMelody) {
          totalCorrect += correctNow;
          totalAttempts += NOTE_COUNT;
          scoredThisMelody = true;
          updateScore();
        }

        // Si 4/4: congelar play/check y activar solo nueva
        if (correctNow === NOTE_COUNT) {
          unlocked = true;
          listenBtn.disabled = true;
          checkBtn.disabled = true;
          newBtn.disabled = false;
        } else {
          newBtn.disabled = true;
        }
      }

      function newMelody() {
        if (newBtn.disabled) return;

        melodyIndex++;
        titleEl.textContent = `Melodía ${melodyIndex}`;

        currentFreqs = pickPrettyMelody();
        answer = generateAnswer();
        scoredThisMelody = false;
        unlocked = false;

        // Descongelar botones
        listenBtn.disabled = false;
        checkBtn.disabled = false;

        // Reset selecciones: SIN amarillo hasta que elijan
        for (let i = 0; i < NOTE_COUNT; i++) selections[i] = null;

        // Limpiar estilos
        groups.forEach((group) => {
          const buttons = group.querySelectorAll("button.note");
          buttons.forEach((btn) => btn.classList.remove("result-ok", "result-bad", "selected"));
        });

        newBtn.disabled = true;
      }

      listenBtn.addEventListener("click", playAnswerMelody);
      checkBtn.addEventListener("click", checkAnswers);
      newBtn.addEventListener("click", newMelody);
    </script>
  </body>
</html>
